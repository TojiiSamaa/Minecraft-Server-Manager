# =============================================================================
# FICHIER DE DEVELOPPEMENT UNIQUEMENT
# NE PAS UTILISER EN PRODUCTION
# Contient des mots de passe par defaut et des outils de debug
# =============================================================================

# =============================================================================
# Docker Compose Override - Configuration Developpement
# =============================================================================
# Ce fichier est automatiquement charge avec docker-compose.yml
# Il contient les configurations specifiques au developpement
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Bot Discord - Configuration Developpement
  # ---------------------------------------------------------------------------
  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
      target: development
    volumes:
      # Code source avec hot-reload
      - ./bot/src:/app/src:cached
      - ./bot/tests:/app/tests:cached
      - ./templates:/app/templates:cached
      # Persistance des donnees de dev
      - bot-dev-data:/app/data
      # Acces au Docker socket pour gestion des conteneurs
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      # Hot-reload Python
      - WATCHFILES_FORCE_POLLING=true
    ports:
      # Port debugger Python (debugpy) - UNIQUEMENT local
      - "127.0.0.1:5678:5678"
    # Commande de dev avec rechargement automatique - debugger restreint a localhost
    command: >
      python -m debugpy --listen 127.0.0.1:5678 --wait-for-client
      -m watchfiles --filter python src.main
    stdin_open: true
    tty: true
    # Pas de restart automatique en dev pour voir les erreurs
    restart: "no"

  # ---------------------------------------------------------------------------
  # Web Dashboard - Configuration Developpement
  # ---------------------------------------------------------------------------
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: development
    volumes:
      # Code source avec hot-reload Next.js
      - ./web/src:/app/src:cached
      - ./web/public:/app/public:cached
      - ./web/app:/app/app:cached
      # Fichiers de configuration
      - ./web/next.config.js:/app/next.config.js:ro
      - ./web/tailwind.config.ts:/app/tailwind.config.ts:ro
      - ./web/tsconfig.json:/app/tsconfig.json:ro
      - ./web/postcss.config.js:/app/postcss.config.js:ro
      # Exclure node_modules du montage
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - WATCHPACK_POLLING=true
      # API URLs pour le dev
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_WS_URL=ws://localhost:8000/ws
    ports:
      - "3000:3000"
    command: npm run dev
    restart: "no"

  # ---------------------------------------------------------------------------
  # PostgreSQL - Configuration Developpement
  # ---------------------------------------------------------------------------
  postgres:
    ports:
      # Exposer le port pour les outils de dev (pgAdmin, DBeaver, etc.) - UNIQUEMENT local
      - "127.0.0.1:5432:5432"
    environment:
      - POSTGRES_USER=minecraft_dev
      - POSTGRES_PASSWORD=dev_password_123
      - POSTGRES_DB=minecraft_bot_dev
    volumes:
      # Donnees persistantes de dev
      - postgres-dev-data:/var/lib/postgresql/data
      # Scripts d'initialisation
      - ./database/init:/docker-entrypoint-initdb.d:ro
    # Healthcheck plus frequent en dev
    healthcheck:
      interval: 5s
      timeout: 3s
      retries: 5

  # ---------------------------------------------------------------------------
  # Redis - Configuration Developpement
  # ---------------------------------------------------------------------------
  redis:
    ports:
      # Exposer le port pour Redis Insight ou redis-cli - UNIQUEMENT local
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-dev-data:/data
    # Mode debug Redis
    command: redis-server --loglevel verbose --appendonly yes

  # ---------------------------------------------------------------------------
  # Adminer - Interface Web pour PostgreSQL (dev only)
  # ---------------------------------------------------------------------------
  adminer:
    image: adminer:latest
    ports:
      - "127.0.0.1:8080:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
      - ADMINER_DESIGN=nette
    depends_on:
      - postgres
    networks:
      - minecraft-network

  # ---------------------------------------------------------------------------
  # Redis Commander - Interface Web pour Redis (dev only)
  # ---------------------------------------------------------------------------
  redis-commander:
    image: rediscommander/redis-commander:latest
    ports:
      - "127.0.0.1:8081:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
    depends_on:
      - redis
    networks:
      - minecraft-network

  # ---------------------------------------------------------------------------
  # MailHog - Serveur mail de test (dev only)
  # ---------------------------------------------------------------------------
  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "127.0.0.1:1025:1025"  # SMTP
      - "127.0.0.1:8025:8025"  # Interface Web
    networks:
      - minecraft-network

  # ---------------------------------------------------------------------------
  # Serveur Minecraft - Configuration Developpement
  # ---------------------------------------------------------------------------
  minecraft:
    environment:
      - EULA=TRUE
      - TYPE=PAPER
      - VERSION=1.20.4
      - MEMORY=2G
      - ENABLE_RCON=true
      - RCON_PASSWORD=dev_rcon_password
      - RCON_PORT=25575
      - DIFFICULTY=peaceful
      - MODE=creative
      - MOTD=Serveur de Developpement
      - MAX_PLAYERS=5
      - VIEW_DISTANCE=10
      - ONLINE_MODE=false
      - ALLOW_NETHER=true
      - SPAWN_PROTECTION=0
      # Debug logging
      - DEBUG=true
    ports:
      - "25565:25565"
      # RCON - UNIQUEMENT local
      - "127.0.0.1:25575:25575"
    volumes:
      - minecraft-dev-data:/data
      - ./minecraft/mods:/mods:ro
      - ./minecraft/config:/config:ro
    # Ressources limitees pour le dev
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 2G

# =============================================================================
# Volumes de Developpement
# =============================================================================
volumes:
  bot-dev-data:
    name: minecraft-bot-dev-data
  postgres-dev-data:
    name: minecraft-postgres-dev-data
  redis-dev-data:
    name: minecraft-redis-dev-data
  minecraft-dev-data:
    name: minecraft-server-dev-data

# =============================================================================
# Reseau de Developpement
# =============================================================================
networks:
  minecraft-network:
    name: minecraft-dev-network
    driver: bridge
